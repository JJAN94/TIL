# 4일차

몽고몽고

use my_test

```javascript
// 예제 컬렉션 추가
db.createCollection("students", {
   validator: {
      $jsonSchema: {
         bsonType: "object",
         required: [ "name", "year", "major", "address" ],
         properties: {
            name: {
               bsonType: "string",
               description: "must be a string and is required"
            },
            year: {
               bsonType: "int",
               minimum: 2017,
               maximum: 3017,
               description: "must be an integer in [ 2017, 3017 ] and is required"
            },
            major: {
               enum: [ "Math", "English", "Computer Science", "History", null ],
               description: "can only be one of the enum values and is required"
            },
            gpa: {
               bsonType: [ "double" ],
               description: "must be a double if the field exists"
            },
            address: {
               bsonType: "object",
               required: [ "city" ],
               properties: {
                  street: {
                     bsonType: "string",
                     description: "must be a string if the field exists"
                  },
                  city: {
                     bsonType: "string",
                     description: "must be a string and is required"
                  }
               }
            }
         }
      }
   }
})
```

```javascript
db.students.validate()

{
        "ns" : "my_test.students",
        "nInvalidDocuments" : 0,
        "nrecords" : 0,
        "nIndexes" : 1,
        "keysPerIndex" : {
                "_id_" : 0
        },
        "indexDetails" : {
                "_id_" : {
                        "valid" : true
                }
        },
        "valid" : true,
        "warnings" : [ ],
        "errors" : [ ],
        "extraIndexEntries" : [ ],
        "missingIndexEntries" : [ ],
        "ok" : 1
}

> db.students.getDB()
my_test
> db
my_test
```



이것도 추가

```javascript
> db.createCollection( "contacts",
...    { validator: { $or:
...       [
...          { phone: { $type: "string" } },
...          { email: { $regex: /@mongodb\.com$/ } },
...          { status: { $in: [ "Unknown", "Incomplete" ] } }
...       ]
...    }
... } )

{ "ok" : 1 }
```

```javascript
> db.contacts.insert([
...    { "_id": 1, "name": "Anne", "phone": "+1 555 123 456", "city": "London", "status": "Complete" },
...    { "_id": 2, "name": "Ivan", "city": "Vancouver" }
... ])

BulkWriteResult({
        "writeErrors" : [
                {
                        "index" : 1,
                        "code" : 121,
                        "errmsg" : "Document failed validation",
                        "op" : {
                                "_id" : 2,
                                "name" : "Ivan",
                                "city" : "Vancouver"
                        }
                }
        ],
        "writeConcernErrors" : [ ],
        "nInserted" : 1,
        "nUpserted" : 0,
        "nMatched" : 0,
        "nModified" : 0,
        "nRemoved" : 0,
        "upserted" : [ ]
})
```

```javascript
> db.contacts.validate()
{
        "ns" : "my_test.contacts",
        "nInvalidDocuments" : 0,
        "nrecords" : 1,
        "nIndexes" : 1,
        "keysPerIndex" : {
                "_id_" : 1
        },
        "indexDetails" : {
                "_id_" : {
                        "valid" : true
                }
        },
        "valid" : true,
        "warnings" : [ ],
        "errors" : [ ],
        "extraIndexEntries" : [ ],
        "missingIndexEntries" : [ ],
        "ok" : 1
}
```

```javascript
> db.runCommand( {
...    collMod: "contacts",
...    validator: { $jsonSchema: {
...       bsonType: "object",
...       required: [ "phone", "name" ],
...       properties: {
...          phone: {
...             bsonType: "string",
...             description: "must be a string and is required"
...          },
...          name: {
...             bsonType: "string",
...             description: "must be a string and is required"
...          }
...       }
...    } },
...    validationLevel: "moderate"
... } )
{ "ok" : 1 }
```

```javascript
> db.contacts.insert([
...    { "_id": 1, "name": "Anne", "phone": "+1 555 123 456", "city": "London", "status": "Complete" },
...    { "_id": 2, "name": "Ivan", "city": "Vancouver" }
... ])
BulkWriteResult({
        "writeErrors" : [
                {
                        "index" : 0,
                        "code" : 11000,
                        "errmsg" : "E11000 duplicate key error collection: my_test.contacts index: _id_ dup key: { _id: 1.0 }", //에러가 뜬다.
                        "op" : {
                                "_id" : 1,
                                "name" : "Anne",
                                "phone" : "+1 555 123 456",
                                "city" : "London",
                                "status" : "Complete"
                        }
                }
        ],
        "writeConcernErrors" : [ ],
        "nInserted" : 0,
        "nUpserted" : 0,
        "nMatched" : 0,
        "nModified" : 0,
        "nRemoved" : 0,
        "upserted" : [ ]
})
```





### Transactions은 도움말 한번 볼것





geospatial

2d : 좌표 평면 계산 - 하나의 인덱스

2d sphere : 좌표, GeoJson - 위치 상관 없이 인덱스, 복합 인덱스

---



```javascript
use geotest
// 난수를 이용한 임의 좌표를 잡아서 데이터셋을 만들어보자
var baseLng = 127.077025;
var baseLat = 37.545018;

var diffLng = 126.9988212;
var diffLat = 37.4952724;

var categories = ['카페', '은행', '편의점']

for (var i=1;i<=100;i++){
    var myLng = baseLng + (Math.random()*diffLng);
    var myLat = baseLat + (Math.random()*diffLat);
    
    var myCategories = categories[Math.floor(Math.random()*categories.length)];
    
    db.places.save({location:[myLng, myLat],
                    category :myCategories});
}

> db.places.find().count()
100
```



Q1) 인덱스를 작성한다.

```javascript
> db.places.getIndexes()
[ { "v" : 2, "key" : { "_id" : 1 }, "name" : "_id_" } ]

> db.places.ensureIndex({location:"2d", category:1});
{
        "ok" : 0,
        "errmsg" : "Index build failed: c8d4abaf-0338-4b23-818b-c0d357428c31: Collection geotest.places ( e009d4c4-cd27-4e05-85cd-54e08302a21a ) :: caused by :: point not in interval of [ -180, 180 ] :: caused by :: { _id: ObjectId('60c9a863daae78110007c3f6'), location: [ 236.9024782736321, 47.86950341836194 ], category: \"카페\" }",
        "code" : 13027,
        "codeName" : "Location13027"
}

> db.places.getIndexes()

// 에러난거임, 범위가 [-180, 180]을 넘어가는 값이 있어서.
```



Q2) -180 ~ 180의 범위를 벗어나는 문서를 찾아보고 삭제하세요.

```javascript
db.places.deleteMany({location:{$gte:[180,180]}},{location:1, _id:0})
// 싯팔... 이것좀 먼져 좀 알려주지 진짜 강사 ㅡㅡ
db.places.find({location:{$lte:[180,180]}},{location:1, _id:0}).count()
40

 db.places.ensureIndex({location:"2d", category:1});
{
        "createdCollectionAutomatically" : false,
        "numIndexesBefore" : 1,
        "numIndexesAfter" : 2,
        "ok" : 1
}

> db.places.getIndexes()
[
        {
                "v" : 2,
                "key" : {
                        "_id" : 1
                },
                "name" : "_id_"
        },
        {
                "v" : 2,
                "key" : {
                        "location" : "2d",
                        "category" : 1
                },
                "name" : "location_2d_category_1"
        }
]
```



Q3) 편의점 찾아보자

```javascript
db.places.find({category:"편의점"})
db.places.find({category:"편의점"}).count()
14
```



Q4) 은행을 찾아보자

```javascript
db.places.find({category:"은행"})
db.places.find({category:"은행"}).count()
16
```



Q5) 카페 찾아보자.

```javascript
db.places.find({category:"카페"})
db.places.find({category:"카페"}).count()
10
```



Q6) 내가 지정한 좌표 근처에 편의점, 은행, 카페 중 가장 가까운 10개를 찾아보자.

```javascript
db.places.find({location:{$near:[127.077025, 37.545018]}}).limit(10);

{ "_id" : ObjectId("60c9a863daae78110007c43b"), "location" : [ 133.67632094913287, 42.7642736420293 ], "category" : "카 페" }
{ "_id" : ObjectId("60c9a863daae78110007c3fd"), "location" : [ 142.81535366751316, 43.6706645772364 ], "category" : "카 페" }
{ "_id" : ObjectId("60c9a863daae78110007c455"), "location" : [ 131.26727010091733, 57.135880650831346 ], "category" : " 편의점" }
{ "_id" : ObjectId("60c9a863daae78110007c3fa"), "location" : [ 143.35607631020332, 51.73309481849915 ], "category" : "은행" }
{ "_id" : ObjectId("60c9a863daae78110007c42c"), "location" : [ 137.07722893780283, 58.60516750845674 ], "category" : "편의점" }
{ "_id" : ObjectId("60c9a863daae78110007c416"), "location" : [ 151.78487947094595, 39.96110294205864 ], "category" : "편의점" }
{ "_id" : ObjectId("60c9a863daae78110007c414"), "location" : [ 152.16397509036526, 44.48135155568505 ], "category" : "은행" }
{ "_id" : ObjectId("60c9a863daae78110007c41f"), "location" : [ 130.21486785144148, 64.04041815229208 ], "category" : "은행" }
{ "_id" : ObjectId("60c9a863daae78110007c445"), "location" : [ 149.90680623768066, 56.18725182215444 ], "category" : "편의점" }
{ "_id" : ObjectId("60c9a863daae78110007c459"), "location" : [ 132.0451172142532, 69.0392047999051 ], "category" : "은행" }
```



Q7) 여기서 가장 가까운 5개의 편의점, 은행, 카페를 찾아보자.

```javascript
{ "_id" : ObjectId("60c9a863daae78110007c3fd"), "location" : [ 142.81535366751316, 43.6706645772364 ], "category" : "카 페" }

db.places.find({location:[142.81535366751316, 43.6706645772364]})
{ "_id" : ObjectId("60c9a863daae78110007c3fd"), "location" : [ 142.81535366751316, 43.6706645772364 ], "category" : "카 페" }

db.places.find({location:{$near:[142.81535366751316, 43.6706645772364]}}).limit(5)

{ "_id" : ObjectId("60c9a863daae78110007c3fd"), "location" : [ 142.81535366751316, 43.6706645772364 ], "category" : "카 페" }
{ "_id" : ObjectId("60c9a863daae78110007c3fa"), "location" : [ 143.35607631020332, 51.73309481849915 ], "category" : "은행" }
{ "_id" : ObjectId("60c9a863daae78110007c43b"), "location" : [ 133.67632094913287, 42.7642736420293 ], "category" : "카 페" }
{ "_id" : ObjectId("60c9a863daae78110007c414"), "location" : [ 152.16397509036526, 44.48135155568505 ], "category" : "은행" }
{ "_id" : ObjectId("60c9a863daae78110007c416"), "location" : [ 151.78487947094595, 39.96110294205864 ], "category" : "편의점" }
```





Q8) 00근처에서 근방 0.25거리에 있는 은행을 찾아보자.

```javascript
db.places.find({location:{$near:[142.81535366751316, 43.6706645772364], $maxDistance:0.25}})
{ "_id" : ObjectId("60c9a863daae78110007c3fd"), "location" : [ 142.81535366751316, 43.6706645772364 ], "category" : "카 페" }
```





Q9) 00 근처에서 가장 멀리 있는 편의점을 3개 찾아보자.

```javascript
```



Q10) 00 근처에서 가장 멀리 있는 은행과의 가운데 있는 지점의 편의점을 찾아 보자.

```javascript
```









mongofiles













































































